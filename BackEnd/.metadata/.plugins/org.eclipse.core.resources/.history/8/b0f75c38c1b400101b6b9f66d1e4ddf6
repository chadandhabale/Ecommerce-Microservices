package com.example.paymentGateway.ServiceImpl;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

import org.modelmapper.ModelMapper;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.paymentGateway.Client.PaymentClient;
import com.example.paymentGateway.DTO.*;
import com.example.paymentGateway.Entity.*;
import com.example.paymentGateway.Repository.*;
import com.example.paymentGateway.Service.OrderService;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
@Transactional
public class OrderServiceImpl implements OrderService {

    private final OrderRepository orderRepository;
    private final ProductRepository productRepository;
    private final UserRepository userRepository;
    private final ModelMapper modelMapper;
    private final PaymentClient paymentClient; // ‚úÖ Feign client for PaymentService

    @Override
    public OrderDTO placeOrder(Long userId, Map<Long, Integer> productQuantities, Double totalAmount) {
        log.info("üõí Placing order for user ID: {}", userId);

        // 1Ô∏è‚É£ Validate user
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new RuntimeException("User not found with ID: " + userId));

        // 2Ô∏è‚É£ Create order entity
        Orders order = new Orders();
        order.setUser(user);
        order.setOrderDate(LocalDateTime.now());
        order.setStatus(Status.PENDING);
        order.setTotalAmount(new java.math.BigDecimal(totalAmount));

        // 3Ô∏è‚É£ Add order items
        List<OrderItem> orderItems = productQuantities.entrySet().stream().map(entry -> {
            Product product = productRepository.findById(entry.getKey())
                    .orElseThrow(() -> new RuntimeException("Product not found with ID: " + entry.getKey()));

            OrderItem item = new OrderItem();
            item.setOrder(order);
            item.setProduct(product);
            item.setQuantity(entry.getValue());
            item.setPrice(product.getPrice());
            return item;
        }).collect(Collectors.toList());

        order.setOrderItems(orderItems);
        Orders savedOrder = orderRepository.save(order);
        log.info("‚úÖ Order saved successfully: {}", savedOrder.getId());

        // 4Ô∏è‚É£ Create payment order
        PaymentRequest paymentRequest = new PaymentRequest(userId, savedOrder.getId(), totalAmount);
        PaymentResponse paymentResponse = paymentClient.createPayment(paymentRequest);
        log.info("üí≥ Razorpay Order Created: {}", paymentResponse);

        // 5Ô∏è‚É£ Build Response DTO
        OrderDTO orderDTO = modelMapper.map(savedOrder, OrderDTO.class);
        orderDTO.setUserName(user.getName());
        orderDTO.setEmail(user.getEmail());
        orderDTO.setPaymentId(paymentResponse.getRazorpayOrderId());
        orderDTO.setPaymentStatus(paymentResponse.getStatus());
        orderDTO.setRazorpayKeyId(paymentResponse.getKeyId()); // For frontend checkout

        return orderDTO;
    }


    @Override
    public List<OrderDTO> getAllOrders() {
        log.info("üì¶ Fetching all orders...");
        return orderRepository.findAllOrdersWithUser().stream()
                .map(order -> modelMapper.map(order, OrderDTO.class))
                .collect(Collectors.toList());
    }

    @Override
    public List<OrderDTO> getOrdersByUserId(Long userId) {
        log.info("üì¶ Fetching orders for user ID: {}", userId);
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new RuntimeException("User not found with ID: " + userId));

        return orderRepository.findByUser(user).stream()
                .map(order -> modelMapper.map(order, OrderDTO.class))
                .collect(Collectors.toList());
    }

    @Override
    public List<Orders> findByOrderStatus(Status status) {
        log.info("üîç Fetching orders by status: {}", status);
        return orderRepository.findByStatus(status);
    }

    @Override
    public OrderDTO updateOrderStatus(Long orderId, String status) {
        log.info("üìù Updating order {} to status {}", orderId, status);
        Orders order = orderRepository.findById(orderId)
                .orElseThrow(() -> new RuntimeException("Order not found with ID: " + orderId));

        try {
            order.setStatus(Status.valueOf(status.toUpperCase()));
        } catch (IllegalArgumentException e) {
            throw new RuntimeException("Invalid order status: " + status);
        }

        Orders updatedOrder = orderRepository.save(order);
        return modelMapper.map(updatedOrder, OrderDTO.class);
    }

    @Override
    public OrderDTO cancelOrder(Long orderId) {
        log.info("üö´ Cancelling order with ID: {}", orderId);
        Orders order = orderRepository.findById(orderId)
                .orElseThrow(() -> new RuntimeException("Order not found with ID: " + orderId));

        if (order.getStatus() == Status.DELIVERED || order.getStatus() == Status.CANCELLED) {
            throw new RuntimeException("Order cannot be cancelled (status: " + order.getStatus() + ")");
        }

        order.setStatus(Status.CANCELLED);
        Orders cancelledOrder = orderRepository.save(order);
        return modelMapper.map(cancelledOrder, OrderDTO.class);
    }

    @Override
    public List<OrderDTO> getRecentOrders(int days) {
        log.info("üìÖ Fetching recent orders placed in the last {} days", days);
        LocalDateTime startDate = LocalDateTime.now().minusDays(days);
        List<Orders> recentOrders = orderRepository.findRecentOrders(startDate);

        return recentOrders.stream().map(order -> {
            OrderDTO dto = modelMapper.map(order, OrderDTO.class);
            dto.setUserName(order.getUser().getName());
            dto.setEmail(order.getUser().getEmail());

            if (order.getOrderItems() != null) {
                dto.setOrderItems(order.getOrderItems().stream()
                        .map(item -> new OrderItemDTO(
                                item.getProduct().getId(),
                                item.getProduct().getName(),
                                item.getPrice(),
                                item.getQuantity()))
                        .collect(Collectors.toList()));
            }
            return dto;
        }).collect(Collectors.toList());
    }
}
